<html>
<head>
<script src="jquery.js"></script> <!--  needed for this sample, not for qeo itself -->
<script src="qeo.js"></script> <!--  load qeo library -->
<script src="QSimpleChat_ChatMessage.js"></script> <!-- Load qeo types. Generated by qeo-codegen. -->
<script src="QeoManifest-QSimplechat.js"></script> <!-- Load the manifest for this sample -->

<script type="text/javascript">


function startQeo() {
	var reader, writer;
    var factoryOptions = {"manifest": org_qeo_sample_simplechat_ChatMessage_Manifest, "on": {"termination": termination}};
    
    //create a Qeo factory. Pass the manifest file as an option.
    Qeo.createFactory(factoryOptions).then(function(factory){
        //creation of the factory is asynchronous and will enter here is created.
        
        //now create the readers and writer.
        //this also is asynchronous and will return a promise.
        var promisedWriter = factory.createEventWriter("org::qeo::sample::simplechat::ChatMessage");
        var promisedReader = factory.createEventReader("org::qeo::sample::simplechat::ChatMessage");

        //chain the creation of readers/writers to the first promise.
        return promisedWriter.then(function(_writer) {
            writer = _writer;
            return promisedReader.then(function(_reader) {
                   reader = _reader;
            });
        })

        
    }).then(function() {
        //now both readers/writers are created.
           $("#send").click(function() {
           //add hook to the send button.
            var data = { 'from' : $('#who').val(), 'message' : $('#text').val() };
            writer.write(data);
            $("#text").val("");
        });
       
        reader.on("data",function (data) {
            //handle read events
            $('#output').append('<div class="message"><span class="username">' + data.from + '</span><span class="messagetext">'+data.message+'</span></div>');
            $('#output').scrollTop($('#output').get(0).scrollHeight);
        });
            
    }, function(error) {
        //error in factory/reader/writer creation.
        console.error(error);
        alert(error);
    });
}
//function that will be called whenever the factory is terminated abnormally. -> restart everything.
function termination() {
    $("#send").unbind("click"); //remove old onlick handler.
    startQeo(); //restart qeo.
}

//----------------------------------
//Wait until document is ready.
//----------------------------------
$(document).ready(function() {
    startQeo();
});

//----------------------------------
// Reload document => cleanup.
//----------------------------------
window.addEventListener('unload', function() {Qeo.cleanup();});
</script>

<style>
    .username {
        color: blue;
        font-weight: bold;
    }
    .messagetext {
        color: black;
    }
    .message {
        border: solid 1px black;
    }
    span {
        display: inline-block;
        *display: inline;/* for IE7*/
        *zoom:1;/* for IE7*/
        width: auto !important;
        width 150px;
        min-width: 150px;
    }
</style>
</head>

<body>
<div id="input" style="clear:both;">
    User <input id="who" type="text" value="WebViewUser"/>
    Message <input id="text" type="text" style="width:80%;"/>
    <button id="send">Send</button>
</div>
<hr/>
<div id="output" style="border:solid black; padding: 10px; overflow-y:auto; margin:0px; margin-bottom: 5px; height: 60%;">
    <div class="message">
        <span class="username">FROM</span><span class="messagetext">MESSAGE</span>
    </div>
</div>
</body>
</html>

