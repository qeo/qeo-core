<html>
<head>
<script src="jquery.js"></script> <!--  needed for this sample, not for qeo itself -->
<script src="qeo.js"></script> <!--  load qeo library -->
<script src="QSimpleChat_ChatMessage.js"></script> <!-- Load qeo types. Generated by qeo-codegen. -->
<script src="QSimpleChat_ChatParticipant.js"></script> <!-- Load qeo types. Generated by qeo-codegen. -->
<script src="QeoManifest-QSimplechat.js"></script> <!-- Load the manifest for this sample -->

<script type="text/javascript">

var currentParticipantData;

//----------------------------------
// Wait until document is ready
//----------------------------------
$(document).ready(function() {
    var factoryOptions = {"manifest": org_qeo_sample_simplechat_ChatMessage_Manifest};
    
    //create a Qeo factory. Pass the manifest file as an option.
    Qeo.createFactory(factoryOptions).then(function(factory){
        //creation of the factory is asynchronous and will enter here is created.
        
        //now create the readers and writer.
        //this also is asynchronous and will return a promise.
        var promisedMessageWriter = factory.createEventWriter("org::qeo::sample::simplechat::ChatMessage");
        var promisedMessageReader = factory.createEventReader("org::qeo::sample::simplechat::ChatMessage");

        var promisedParticipantWriter = factory.createStateWriter("org::qeo::sample::simplechat::ChatParticipant");
        var promisedParticipantReader = factory.createStateReader("org::qeo::sample::simplechat::ChatParticipant");

        promisedMessageWriter.then(function(writer) {
            //writer is created.
            $("#send").click(function() {
                //add hook to the send button.
                var data = { 'from' : $('#who').val(), 'message' : $('#text').val() };
                writer.write(data);
                $("#text").val("");
            });
        }, function(error) {
            //error in writer creation.
            console.error(error);
            alert(error);
        });
        
        promisedMessageReader.then(function(reader) {
            //reader is created.
            reader.on("data",function (data) {
                //handle read events.
                $('#output').append('<div class="message"><span class="username">' + data.from + '</span><span class="messagetext">'+data.message+'</span></div>');
                $('#output').scrollTop($('#output').get(0).scrollHeight);
            });
        }, function(error) {
            //error in reader creation.
            console.error(error);
            alert(error);
        });

        promisedParticipantWriter.then(function(writer) {
            var stateEnum = Qeo.getEnum("org::qeo::sample::simplechat::ChatState");
            var dictionary = {}
            dictionary["AVAILABLE"] = stateEnum.AVAILABLE;
            dictionary["IDLE"] = stateEnum.IDLE;
            dictionary["BUSY"] = stateEnum.BUSY;
            dictionary["AWAY"] = stateEnum.AWAY;
            var data = { 'name' : $('#who').val(), 'state' : dictionary[$('input[name=state]:checked').val()]};
            writer.write(data);
            currentParticipantData = data;
            //writer is created.
            $("input.state-button").click(function(event) {
                //add hook to the send button.
                var data = { 'name' : $('#who').val(), 'state' : dictionary[$(this).val()]};
                writer.write(data);
                currentParticipantData = data;
            });
            $('#who').change(function(){
                writer.remove(currentParticipantData);
                var data = { 'name' : $('#who').val(), 'state' : dictionary[$('input[name=state]:checked').val()]};
                writer.write(data);
                currentParticipantData = data;
            });
            
        }, function(error) {
            //error in writer creation.
            console.error(error);
            alert(error);
        });
        
        promisedParticipantReader.then(function(reader) {
            //reader is created.
            reader.on("update",function () {
                var stateEnum = Qeo.getEnum("org::qeo::sample::simplechat::ChatState");
                reader.iterate().then(function(values) {
                    $('#participant_list').empty();
                    for (data in values){
                        var stateStr = stateEnum.toString(values[data].state);
                //handle read events.
                        $('#participant_list').append('<li><span class="username">' + values[data].name + '</span><span class="state">'+stateStr+'</span></li>');
                    }
                });
            });
        }, function(error) {
            //error in reader creation.
            console.error(error);
            alert(error);
        });
    }, function(error) {
        //error in factory creation.
        console.error(error);
        alert(error);
    });
});
//----------------------------------
// Reload document => cleanup
//----------------------------------
window.addEventListener('unload', function() {Qeo.cleanup();});

</script>

<style>
    .username {
        color: blue;
        font-weight: bold;
    }
    .messagetext {
        color: black;
    }
    .message {
        border: solid 1px black;
    }
    span {
        display: inline-block;
        *display: inline;/* for IE7*/
        *zoom:1;/* for IE7*/
        width: auto !important;
        width 150px;
        min-width: 150px;
    }
</style>
</head>

<body>
<div id="input" style="clear:both; width:70%;">
    User <input id="who" type="text" value="WebViewUser"/>
    <div class="message">State 
              <input type="radio" class="state-button" name="state" id="state1" value="AVAILABLE" checked>Available</option>
              <input type="radio"  class="state-button" name="state" id="state2" value="IDLE">Idle</option>
              <input type="radio"  class="state-button" name="state" id="state3" value="BUSY">Busy</option>
              <input type="radio"  class="state-button" name="state" id="state4" value="AWAY">Away</option>
    </div>
    Message <input id="text" type="text" style="width:80%;"/>
    <button id="send">Send</button>
</div>
<hr/>
<div id="output" style="float:left; border:solid black; padding: 10px; width:55%; overflow-y:auto; margin:0px; margin-bottom: 5px; height: 60%;">
    <div class="message">
        <span class="username">FROM</span><span class="messagetext">MESSAGE</span>
    </div>
</div>
<div id="participants" style="float:left; border:solid black; padding: 10px; width:25%; overflow-y:auto; margin: 0px; margin-bottom:5px; height: 60%">
    <p>Participants</p>
    <ul id="participant_list"/>
</div>
</body>
</html>

