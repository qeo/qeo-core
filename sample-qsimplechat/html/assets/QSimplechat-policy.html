<html>
<head>
<script src="jquery.js"></script> <!--  needed for this sample, not for qeo itself -->
<script src="qeo.js"></script> <!--  load qeo library -->
<script src="QSimpleChat_ChatMessage.js"></script> <!-- Load qeo types. Generated by qeo-codegen. -->
<script src="QeoManifest-QSimplechat.js"></script> <!-- Load the manifest for this sample -->

<script type="text/javascript">


//----------------------------------
// Wait until document is ready
//----------------------------------
var selectedUserId = -1;
var policyList;
var writer;
$(document).ready(function() {
    var reader;
    var factoryOptions = {"manifest": org_qeo_sample_simplechat_ChatMessage_Manifest};
    Qeo.createFactory(factoryOptions).then(function(factory){
        //make sure to pass enablepolicy: true to the creation of needed readers/writers
        var promisedWriter = factory.createEventWriter("org::qeo::sample::simplechat::ChatMessage", {"enablePolicy": true});
        var promisedReader = factory.createEventReader("org::qeo::sample::simplechat::ChatMessage");

        return promisedWriter.then(function(_writer) {
          writer = _writer;
          return promisedReader.then(function(_reader) {
            reader = _reader;
          });
        })
    }).then(function() {     
        //Everything is now nicely initialized.
        $("#send").click(function() {
          var data = { 'from' : $('#who').val(), 'message' : $('#text').val() };
          writer.write(data);
          $("#text").val("");
        });

        reader.on("data",function (data) {
          $('#output').append('<div class="message"><span class="username">' + data.from + '</span><span class="messagetext">'+data.message+'</span></div>');
          $('#output').scrollTop($('#output').get(0).scrollHeight);
        });
        
        function addUser(id, name) {
            $('#privateUserId').append('<option value="' + id + '"'
                    + (id == selectedUserId ? " selected=\"selected\"" : "") 
                    + '>' + name + '</option>');
        }
        
        writer.on("policyUpdate",function (data) {
            //this callback will be called whenever a policy update is requested or detected by the Qeo system.
            //update the user list to who messages can be send to.
            policyList = data;
            $('#privateUserId').empty();
            addUser(-1, "All");
            for (var index = 0; index < data.users.length; ++index) {
                var user = data.users[index];
                addUser(user.id, user.id); //not possible to get a username yet
               }
        });
        //request a policyupdate to get a list of users.
        writer.requestPolicy(); 
      

    },function(error){
        console.error(error);
        alert(error);
    });
});

//This function will get called when a new private user is selected to send the message to.
//If "all" is selected, all users will get allow:true
//If a specifi user is selected, all users will get allow:false, except for the selected one.
function setNewPolicy() {
    selectedUserId = $('#privateUserId option:selected').val();
    for (var index = 0; index < policyList.users.length; ++index) {
        policyList.users[index].allow =
            (selectedUserId == -1 || policyList.users[index].id == selectedUserId ? true : false);
    }
    //send the new policy to Qeo
    writer.updatePolicy(policyList);
}

//----------------------------------
// Reload document => cleanup
//----------------------------------
window.addEventListener('unload', function() {Qeo.cleanup();});

</script>

<style>
    .username {
        color: blue;
        font-weight: bold;
    }
    .messagetext {
        color: black;
    }
    .message {
        border: solid 1px black;
    }
    span {
        display: inline-block;
        *display: inline;/* for IE7*/
        *zoom:1;/* for IE7*/
        width: auto !important;
        width 150px;
        min-width: 150px;
    }
</style>
</head>

<body>
<div id="input" style="clear:both;">
    User <input id="who" type="text" value="WebViewUser"/><br/>
    Message <input id="text" type="text" style="width:80%;"/><br/>
    Send message to <select id="privateUserId" onchange="setNewPolicy()"></select>
    <button id="send">Send</button>
</div>
<hr/>
<div id="output" style="border:solid black; padding: 10px; overflow-y:auto; margin:0px; margin-bottom: 5px; height: 60%;">
    <div class="message">
        <span class="username">FROM</span><span class="messagetext">MESSAGE</span>
    </div>
</div>
</body>
</html>

